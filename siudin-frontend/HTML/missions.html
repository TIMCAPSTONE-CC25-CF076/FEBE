<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missions - SiUdin</title>
    <link rel="stylesheet" href="../CSS/missions.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1 class="brand-name">SiUdin</h1>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="home.html" class="nav-link">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle">
                        Fitur <i class="fas fa-chevron-down"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                </li>
            </ul>
            
            <div class="nav-actions">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <div class="user-profile">
                    <img src="/placeholder.svg?height=40&width=40" alt="User Profile" class="profile-img">
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Missions</h1>
            
            <div class="welcome-section">
                <h2 class="welcome-text">Welcome back, <span id="welcome-username-missions">Siti</span>!</h2>
                <div class="user-stats">
                    <span class="xp-badge" id="user-xp-missions">10 XP</span>
                    <span class="level-badge" id="user-level-missions">Level 1</span>
                </div>
            </div>

            <div class="missions-grid">
                <section class="progress-card">
                    <div class="progress-content">
                        <h3 class="progress-title" id="progress-card-title">You have completed 0 out of 0 daily task. Great work!</h3>
                        
                        <p class="progress-description">
                            Complete all tasks in the "Daily Challenges" section on the right side of this page to earn XP and get closer to your next trophy
                        </p>
                        
                        <div class="progress-circle">
                            <div class="circle-progress" data-progress="0">
                                <span class="progress-text">0%</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="daily-challenges">
                    <h2 class="section-title">Daily Challenges</h2>
                    
                    <div class="challenges-section">
                        <h3 class="subsection-title">Completed</h3>
                        <div id="completed-missions-list">
                            </div>
                    </div>
                    
                    <div class="challenges-section">
                        <h3 class="subsection-title uncompleted">Uncompleted</h3>
                        <div id="uncompleted-missions-list">
                            </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('You need to be logged in to view your missions.');
                window.location.href = 'sign-in.html';
                return;
            }

            // Fetch User Profile Data
            async function fetchUserProfile() {
                try {
                    const response = await fetch('http://localhost:3000/api/users/profile', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`, // 
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        document.getElementById('welcome-username-missions').textContent = data.username; // 
                        document.getElementById('user-xp-missions').textContent = `${data.xp} XP`; // 
                        document.getElementById('user-level-missions').textContent = `Level ${data.level}`; // 
                    } else {
                        console.error('Failed to fetch user profile:', data.message);
                        if (response.status === 401 || response.status === 403) { // Unauthorized or Forbidden 
                            alert('Session expired. Please log in again.');
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'sign-in.html';
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user profile:', error);
                }
            }

            // Fetch User Missions
            async function fetchUserMissions() {
                try {
                    const response = await fetch('http://localhost:3000/api/missions/my-missions', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`, // 
                            'Content-Type': 'application/json'
                        }
                    });
                    const missions = await response.json();
                    if (response.ok) {
                        const completedList = document.getElementById('completed-missions-list');
                        const uncompletedList = document.getElementById('uncompleted-missions-list');
                        completedList.innerHTML = '';
                        uncompletedList.innerHTML = '';

                        let completedCount = 0;
                        const totalMissions = missions.length;

                        missions.forEach(mission => {
                            const missionItem = document.createElement('div');
                            missionItem.classList.add('challenge-item');
                            missionItem.setAttribute('onclick', `location.href='modul.html?missionId=${mission.id}'`); // Link to relevant module/detail page

                            const missionContent = `
                                <div class="challenge-content">
                                    <span class="challenge-code">MIS${String(mission.id).padStart(3, '0')}:</span>
                                    <span class="challenge-name">${mission.title}</span>
                                </div>
                            `;

                            if (mission.is_completed) { // 
                                missionItem.classList.add('completed');
                                missionItem.innerHTML = missionContent + `
                                    <div class="challenge-status">
                                        <i class="fas fa-check"></i>
                                    </div>
                                `;
                                completedList.appendChild(missionItem);
                                completedCount++;
                            } else {
                                missionItem.classList.add('uncompleted');
                                missionItem.innerHTML = missionContent + `
                                    <div class="challenge-time">
                                        ${mission.current_progress || 0}/${mission.required_completion_count}
                                    </div>
                                `;
                                uncompletedList.appendChild(missionItem);
                            }
                        });

                        // Update progress card
                        const progressPercentage = totalMissions > 0 ? Math.round((completedCount / totalMissions) * 100) : 0;
                        document.getElementById('progress-card-title').textContent = `You have completed ${completedCount} out of ${totalMissions} daily task. Great work!`;
                        
                        const circleProgress = document.querySelector('.circle-progress');
                        circleProgress.setAttribute('data-progress', progressPercentage);
                        circleProgress.style.background = `conic-gradient(#ffffff ${progressPercentage}%, rgba(255, 255, 255, 0.3) ${progressPercentage}%)`;
                        document.querySelector('.progress-text').textContent = `${progressPercentage}%`;

                    } else {
                        console.error('Failed to fetch user missions:', missions.message);
                    }
                } catch (error) {
                    console.error('Error fetching user missions:', error);
                }
            }

            // Initial data load
            fetchUserProfile();
            fetchUserMissions();
        });
    </script>
</body>
</html>